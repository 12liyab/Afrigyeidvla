<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Afrigyei Testing Station - Vehicle Inspection</title>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf-autotable/3.8.2/jspdf.plugin.autotable.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/crypto-js/4.1.1/crypto-js.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>
    <link href="https://fonts.googleapis.com/css2?family=Roboto:wght@300;400;500;700&display=swap" rel="stylesheet">
    <style>
        body {
            font-family: 'Roboto', sans-serif; 
            margin: 0;
            padding: 0;
            background: #f4f7fa;
            color: #333;
            min-height: 100vh;
            overflow-x: hidden;
            position: relative;
        }

        body::before {
            content: '';
            position: absolute;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: radial-gradient(circle, rgba(52, 152, 219, 0.1) 0%, rgba(255, 255, 255, 0) 70%);
            animation: pulse 8s infinite;
            z-index: -1;
        }

        @keyframes pulse {
            0% { transform: scale(1); opacity: 0.5; }
            50% { transform: scale(1.2); opacity: 0.3; }
            100% { transform: scale(1); opacity: 0.5; }
        }

        .auth-screen {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100vh;
            background: linear-gradient(135deg, #2c3e50, #3498db);
            display: flex;
            justify-content: center;
            align-items: center;
            z-index: 10000;
            animation: gradientShift 10s ease infinite;
            overflow: hidden;
        }

        .auth-screen::before {
            content: '';
            position: absolute;
            width: 200%;
            height: 200%;
            background: radial-gradient(circle, rgba(255, 255, 255, 0.1) 0%, transparent 70%);
            animation: rotateGlow 15s linear infinite;
        }

        @keyframes rotateGlow {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }

        @keyframes gradientShift {
            0% { background-position: 0% 50%; }
            50% { background-position: 100% 50%; }
            100% { background-position: 0% 50%; }
        }

        .auth-container {
            background: rgba(255, 255, 255, 0.95);
            padding: 40px;
            border-radius: 10px;
            box-shadow: 0 4px 20px rgba(0, 0, 0, 0.15);
            width: 350px;
            transform: scale(0.9) rotate(-2deg);
            transition: all 0.4s ease;
            position: relative;
            backdrop-filter: blur(5px);
        }

        .auth-container:hover {
            transform: scale(1) rotate(0deg);
            box-shadow: 0 10px 40px rgba(0, 0, 0, 0.25);
        }

        .auth-logo {
            position: absolute;
            top: -80px;
            left: 50%;
            transform: translateX(-50%);
            width: 100px;
            height: 100px;
            animation: bounceLogo 2s infinite;
        }

        @keyframes bounceLogo {
            0%, 100% { transform: translateX(-50%) translateY(0); }
            50% { transform: translateX(-50%) translateY(-10px); }
        }

        .auth-container h2 {
            margin: 20px 0;
            color: #2c3e50;
            font-weight: 500;
            position: relative;
            overflow: hidden;
        }

        .auth-container h2::after {
            content: '';
            position: absolute;
            bottom: -5px;
            left: -100%;
            width: 100%;
            height: 3px;
            background: linear-gradient(to right, transparent, #3498db, transparent);
            animation: slideUnderline 2s infinite;
        }

        @keyframes slideUnderline {
            0% { left: -100%; }
            50% { left: 0%; }
            100% { left: 100%; }
        }

        .auth-container input {
            width: 100%;
            padding: 12px;
            margin: 10px 0;
            border: 1px solid #ddd;
            border-radius: 5px;
            box-sizing: border-box;
            transition: all 0.3s ease;
            background: rgba(255, 255, 255, 0.8);
        }

        .auth-container input:focus {
            border-color: #3498db;
            outline: none;
            box-shadow: 0 0 12px rgba(52, 152, 219, 0.5);
            transform: scale(1.02);
        }

        .auth-container button {
            width: 100%;
            padding: 12px;
            background: #3498db;
            border: none;
            border-radius: 5px;
            color: white;
            font-weight: 500;
            cursor: pointer;
            transition: all 0.3s ease;
            position: relative;
            overflow: hidden;
        }

        .auth-container button::before {
            content: '';
            position: absolute;
            top: -50%;
            left: -50%;
            width: 200%;
            height: 200%;
            background: radial-gradient(circle, rgba(255, 255, 255, 0.3) 0%, transparent 70%);
            transform: rotate(30deg);
            transition: all 0.5s ease;
        }

        .auth-container button:hover::before {
            transform: rotate(0deg) scale(1.5);
        }

        .auth-container button:hover {
            background: #2980b9;
            transform: translateY(-2px);
        }

        .toggle-link {
            color: #3498db;
            cursor: pointer;
            margin-top: 15px;
            display: block;
            text-align: center;
            font-size: 14px;
            transition: all 0.3s ease;
            position: relative;
        }

        .toggle-link:hover {
            color: #2980b9;
            transform: translateX(5px);
        }

        .toggle-link::after {
            content: '→';
            position: absolute;
            right: -15px;
            opacity: 0;
            transition: all 0.3s ease;
        }

        .toggle-link:hover::after {
            opacity: 1;
            right: -10px;
        }

        #welcomeScreen {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100vh;
            background: #2c3e50;
            color: white;
            display: flex;
            justify-content: center;
            align-items: center;
            font-size: 24px;
            font-weight: 500;
            z-index: 9999;
            animation: bounceIn 1s ease;
            overflow: hidden;
        }

        #welcomeScreen::before {
            content: '';
            position: absolute;
            width: 150%;
            height: 150%;
            background: radial-gradient(circle, rgba(52, 152, 219, 0.2) 0%, transparent 70%);
            animation: spinGlow 5s linear infinite;
        }

        @keyframes bounceIn {
            0% { opacity: 0; transform: scale(0.5) rotate(-10deg); }
            60% { opacity: 1; transform: scale(1.1) rotate(5deg); }
            100% { opacity: 1; transform: scale(1) rotate(0deg); }
        }

        @keyframes spinGlow {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }

        .container {
            max-width: 1100px;
            margin: 30px auto;
            background: white;
            padding: 30px;
            border-radius: 10px;
            box-shadow: 0 4px 20px rgba(0, 0, 0, 0.05);
            transform: perspective(1000px) rotateX(-5deg);
            opacity: 0;
            animation: flipIn 0.8s ease-out forwards;
            position: relative;
        }

        .main-logo {
            position: absolute;
            top: -80px;
            left: 50%;
            transform: translateX(-50%);
            width: 120px;
            height: 120px;
            z-index: 1;
        }

        @keyframes flipIn {
            from { opacity: 0; transform: perspective(1000px) rotateX(-90deg); }
            to { opacity: 1; transform: perspective(1000px) rotateX(0deg); }
        }

        .header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 30px;
            border-bottom: 1px solid #eee;
            padding-bottom: 15px;
            position: relative;
        }

        .header h1 {
            margin: 0;
            color: #2c3e50;
            font-weight: 500;
            transition: all 0.3s ease;
        }

        .header h1:hover {
            color: #3498db;
            transform: scale(1.05);
        }

        .header h1::before {
            content: '';
            position: absolute;
            top: -10px;
            left: -10px;
            width: 30px;
            height: 30px;
            background: radial-gradient(circle, rgba(52, 152, 219, 0.2) 0%, transparent 70%);
            animation: orbit 4s linear infinite;
        }

        @keyframes orbit {
            0% { transform: translate(0, 0) rotate(0deg); }
            25% { transform: translate(20px, -20px) rotate(90deg); }
            50% { transform: translate(40px, 0) rotate(180deg); }
            75% { transform: translate(20px, 20px) rotate(270deg); }
            100% { transform: translate(0, 0) rotate(360deg); }
        }

        .user-info {
            display: flex;
            align-items: center;
            gap: 15px;
        }

        .logout-btn {
            background: #e74c3c;
        }

        .logout-btn:hover {
            background: #c0392b;
        }

        .input-group {
            display: grid;
            grid-template-columns: repeat(3, 1fr);
            gap: 20px;
            margin-bottom: 30px;
            position: relative;
        }

        input, button, select {
            padding: 12px;
            border-radius: 5px;
            font-size: 14px;
            transition: all 0.3s ease;
        }

        input, select {
            border: 1px solid #ddd;
            background: rgba(255, 255, 255, 0.9);
        }

        input:focus, select:focus {
            border-color: #3498db;
            box-shadow: 0 0 12px rgba(52, 152, 219, 0.4);
            transform: translateY(-2px);
            outline: none;
        }

        button {
            background: #3498db;
            color: white;
            border: none;
            cursor: pointer;
            font-weight: 500;
            position: relative;
            overflow: hidden;
        }

        button::before {
            content: '';
            position: absolute;
            top: -50%;
            left: -50%;
            width: 200%;
            height: 200%;
            background: radial-gradient(circle, rgba(255, 255, 255, 0.3) 0%, transparent 70%);
            transform: rotate(30deg);
            transition: all 0.5s ease;
        }

        button:hover::before {
            transform: rotate(0deg) scale(1.5);
        }

        button:hover {
            background: #2980b9;
            transform: translateY(-2px);
            box-shadow: 0 5px 15px rgba(52, 152, 219, 0.4);
        }

        .phone-input-container {
            position: relative;
            display: flex;
            align-items: center;
        }

        .phone-prefix {
            position: absolute;
            left: 12px;
            top: 50%;
            transform: translateY(-50%);
            color: #666;
            font-size: 14px;
            pointer-events: none;
            background: #fff;
            padding: 0 4px;
            z-index: 1;
        }

        input[type="tel"] {
            padding-left: 60px;
            width: 100%;
            box-sizing: border-box;
        }

        input[type="tel"]:focus + .phone-prefix {
            color: #3498db;
        }

        .phone-error {
            color: #e74c3c;
            font-size: 12px;
            margin-top: 4px;
            display: none;
        }

        /* Autocomplete styles for datalist */
        input[list="vehicleNames"] {
            position: relative;
        }

        datalist {
            display: none; /* Hidden but used for autocomplete */
        }

        input[list="vehicleNames"]::-webkit-calendar-picker-indicator {
            display: none; /* Prevent date picker icon if mistaken */
        }

        input[list="vehicleNames"]:focus {
            border-color: #3498db;
            box-shadow: 0 0 12px rgba(52, 152, 219, 0.4);
        }

        /* Visual cue for successful vehicle name save */
        input[list="vehicleNames"].saved {
            border-color: #2ecc71;
            transition: border-color 0.5s ease;
        }

        table {
            width: 100%;
            border-collapse: collapse;
            margin-top: 20px;
            overflow: hidden;
            border-radius: 5px;
            box-shadow: 0 2px 10px rgba(0, 0, 0, 0.05);
        }

        th, td {
            padding: 12px;
            text-align: left;
            border-bottom: 1px solid #eee;
            transition: all 0.3s ease;
        }

        th {
            background: #2c3e50;
            color: white;
            font-weight: 500;
            position: relative;
        }

        th::after {
            content: '';
            position: absolute;
            bottom: 0;
            left: 0;
            width: 0;
            height: 2px;
            background: #3498db;
            transition: width 0.3s ease;
        }

        th:hover::after {
            width: 100%;
        }

        tbody tr {
            transition: all 0.3s ease;
        }

        tbody tr:hover {
            background: #f8f9fa;
            transform: scale(1.01);
            box-shadow: 0 2px 5px rgba(0, 0, 0, 0.1);
        }

        .action-btn {
            background: #e74c3c;
            padding: 6px 12px;
            margin: 0 2px;
        }

        .footer {
            text-align: center;
            margin-top: 30px;
            color: #666;
            font-size: 12px;
            opacity: 0;
            animation: fadeUp 0.8s ease-out 0.8s forwards;
            position: relative;
        }

        .footer::before {
            content: '';
            position: absolute;
            top: -20px;
            left: 50%;
            width: 50px;
            height: 1px;
            background: #ddd;
            transform: translateX(-50%);
            animation: expandLine 1s ease forwards;
        }

        @keyframes expandLine {
            from { width: 0; }
            to { width: 50px; }
        }

        #reminderModal, #exportModal {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0, 0, 0, 0.5);
            justify-content: center;
            align-items: center;
            z-index: 1000;
            animation: fadeIn 0.3s ease;
        }

        .modal-content {
            background: white;
            padding: 20px;
            border-radius: 10px;
            max-width: 600px;
            width: 90%;
            max-height: 80vh;
            overflow-y: auto;
            box-shadow: 0 4px 20px rgba(0, 0, 0, 0.2);
            position: relative;
            animation: slideIn 0.3s ease;
        }

        #exportModal .modal-content {
            max-width: 400px;
        }

        .modal-content h2 {
            margin-top: 0;
            color: #2c3e50;
        }

        .close-modal {
            position: absolute;
            top: 10px;
            right: 15px;
            font-size: 20px;
            cursor: pointer;
            color: #666;
        }

        .close-modal:hover {
            color: #e74c3c;
        }

        .reminder-table {
            width: 100%;
            border-collapse: collapse;
            margin-top: 10px;
        }

        .reminder-table th, .reminder-table td {
            padding: 8px;
            border: 1px solid #ddd;
            text-align: left;
        }

        .reminder-table th {
            background: #2c3e50;
            color: white;
        }

        .reminder-table .send-btn {
            background: #2ecc71;
            padding: 6px 12px;
            color: white;
            border: none;
            border-radius: 5px;
            cursor: pointer;
        }

        .reminder-table .send-btn:hover {
            background: #27ae60;
            transform: translateY(-2px);
        }

        #exportModal form label {
            display: block;
            margin: 5px 0;
            font-size: 14px;
        }

        #exportModal form input[type="checkbox"],
        #exportModal form input[type="radio"] {
            margin-right: 8px;
        }

        #exportModal button {
            width: 100%;
            margin-top: 15px;
        }

        @keyframes fadeIn {
            from { opacity: 0; }
            to { opacity: 1; }
        }

        @keyframes slideIn {
            from { transform: translateY(-50px); opacity: 0; }
            to { transform: translateY(0); opacity: 1; }
        }

        @media (max-width: 768px) {
            .input-group {
                grid-template-columns: 1fr;
            }
            .container {
                margin: 15px;
                padding: 20px;
            }
            .main-logo {
                top: -60px;
                width: 80px;
                height: 80px;
            }
            .auth-logo {
                top: -60px;
                width: 80px;
                height: 80px;
            }
            .modal-content {
                width: 95%;
                padding: 15px;
            }
            input[type="tel"] {
                padding-left: 50px;
            }
            .phone-prefix {
                left: 8px;
                font-size: 12px;
            }
        }

        @media (prefers-reduced-motion: reduce) {
            .auth-screen, .container, button, .auth-logo, .main-logo {
                animation: none !important;
                transition: none !important;
            }
        }
    </style>
</head>
<body>
    <!-- Authentication Screen -->
    <div id="authScreen" class="auth-screen">
        <div class="auth-container" id="loginForm">
            <img src="4.jpg-removebg-preview.png" alt="DVLA Logo" class="auth-logo">
            <h2>Login</h2>
            <input type="text" id="loginUsername" placeholder="Username" required aria-label="Username">
            <input type="password" id="loginPassword" placeholder="4-Digit PIN" maxlength="4" inputmode="numeric" pattern="\d{4}" required aria-label="4-Digit PIN">
            <button onclick="login()">Login</button>
            <div class="toggle-link" onclick="showRegister()">Create an Account</div>
            <div class="toggle-link" onclick="forgotCredentials()">Forgot Username or Password?</div>
        </div>
        <div class="auth-container" id="registerForm" style="display: none;">
            <img src="4.jpg-removebg-preview.png" alt="DVLA Logo" class="auth-logo">
            <h2>Register</h2>
            <input type="text" id="regUsername" placeholder="Username" required aria-label="Username">
            <input type="password" id="regPassword" placeholder="4-Digit PIN" maxlength="4" inputmode="numeric" pattern="\d{4}" required aria-label="4-Digit PIN">
            <button onclick="register()">Register</button>
            <div class="toggle-link" onclick="showLogin()">Back to Login</div>
        </div>
    </div>

    <!-- Welcome Screen -->
    <div id="welcomeScreen">
        <h1>Afrigyei Testing Station...</h1>
    </div>

    <!-- Reminder Modal -->
    <div id="reminderModal">
        <div class="modal-content">
            <span class="close-modal" onclick="closeReminderModal()" aria-label="Close modal">×</span>
            <h2>Upcoming Expiry Reminders</h2>
            <p>Customers with vehicle expiry dates within the next 7 days:</p>
            <table class="reminder-table" id="reminderTable">
                <thead>
                    <tr>
                        <th>Customer Name</th>
                        <th>Vehicle Number</th>
                        <th>Telephone Number</th>
                        <th>Expiry Date</th>
                        <th>Action</th>
                    </tr>
                </thead>
                <tbody></tbody>
            </table>
        </div>
    </div>

    <!-- Export Options Modal -->
    <div id="exportModal">
        <div class="modal-content">
            <span class="close-modal" onclick="closeExportModal()" aria-label="Close modal">×</span>
            <h2>Export Options</h2>
            <p>Select columns to export and choose format:</p>
            <form id="exportForm">
                <label><input type="checkbox" name="columns" value="customerName" checked> Customer Name</label><br>
                <label><input type="checkbox" name="columns" value="vehicleName" checked> Vehicle Name</label><br>
                <label><input type="checkbox" name="columns" value="vehicleNumber" checked> Vehicle Number</label><br>
                <label><input type="checkbox" name="columns" value="telephoneNumber" checked> Telephone Number</label><br>
                <label><input type="checkbox" name="columns" value="chassisNumber" checked> Chassis Number</label><br>
                <label><input type="checkbox" name="columns" value="pc" checked> P/C</label><br>
                <label><input type="checkbox" name="columns" value="expiryDate" checked> Expiry Date</label><br>
                <label><input type="checkbox" name="columns" value="status" checked> Status</label><br>
                <label><input type="checkbox" name="columns" value="createdBy" checked> Created By</label><br>
                <br>
                <label><input type="radio" name="exportType" value="pdf" checked> Export to PDF</label>
                <label><input type="radio" name="exportType" value="excel"> Export to Excel</label><br>
                <br>
                <label><input type="checkbox" id="exportFiltered" checked> Export only filtered records</label><br>
                <br>
                <button type="button" onclick="exportRecords()">Export</button>
            </form>
        </div>
    </div>

    <!-- Main Content -->
    <div class="container" id="worksheetContainer">
        <img src="4.jpg-removebg-preview.png" alt="DVLA Logo" class="main-logo">
        <div class="header">
            <h1>Acl.</h1>
            <div class="user-info">
                <span id="userDisplay">User: </span>
                <button class="logout-btn" onclick="logout()">Logout</button>
            </div>
        </div>

        <div class="input-group">
            <input type="text" id="searchInput" placeholder="Search by Vehicle Number..." onkeyup="filterTable()" aria-label="Search by Vehicle Number">
            <select id="statusFilter" onchange="filterTable()" aria-label="Filter by Status">
                <option value="active">Active</option>
                <option value="cleared">Cleared</option>
                <option value="deleted">Deleted</option>
                <option value="all">All</option>
            </select>
            <select id="monthFilter" onchange="filterTable()" aria-label="Filter by Expiry Month">
                <option value="all">None</option>
                <option value="all">All Months</option>
                <option value="1">January</option>
                <option value="2">February</option>
                <option value="3">March</option>
                <option value="4">April</option>
                <option value="5">May</option>
                <option value="6">June</option>
                <option value="7">July</option>
                <option value="8">August</option>
                <option value="9">September</option>
                <option value="10">October</option>
                <option value="11">November</option>
                <option value="12">December</option>
            </select>
            <input type="text" id="customerName" placeholder="Customer Name" required aria-label="Customer Name" />
            <input type="text" id="vehicleName" list="vehicleNames" placeholder="Vehicle Name (e.g., Toyota Corolla)" required aria-label="Vehicle Name" aria-autocomplete="list" aria-controls="vehicleNames" />
            <datalist id="vehicleNames"></datalist>
            <input type="text" id="vehicleNumber" placeholder="Vehicle Number" required aria-label="Vehicle Number" />
            <div class="phone-input-container">
                <input type="tel" id="telephoneNumber" placeholder="Enter 9-digit number" value="+233" maxlength="13" required aria-label="Telephone Number (starts with +233)" />
                <span class="phone-prefix">+233</span>
                <div class="phone-error" id="phoneError">Please enter a valid 9-digit number (e.g., 123456789)</div>
            </div>
            <input type="text" id="chassisNumber" placeholder="Chassis Number" required aria-label="Chassis Number" />
            <input type="text" id="pc" placeholder="P/C" required aria-label="P/C" />
            <input type="date" id="expiryDate" required aria-label="Expiry Date" />
            <button onclick="addRow()">Add Vehicle</button>
        </div>

        <table id="vehicleTable">
            <thead>
                <tr>
                    <th>S.No</th>
                    <th>Customer Name</th>
                    <th>Vehicle Name</th>
                    <th>Vehicle Number</th>
                    <th>Telephone Number</th>
                    <th>Chassis Number</th>
                    <th>P/C</th>
                    <th>Expiry Date</th>
                    <th>Status</th>
                    <th>Created By</th>
                    <th>Action</th>
                </tr>
            </thead>
            <tbody></tbody>
        </table>

        <div style="text-align: center; margin-top: 30px;">
            <button onclick="openExportModal()">Export Records</button>
            <button onclick="confirmClearTable()">Clear Table</button>
            <button onclick="retrieveRecords()">Retrieve Records</button>
            <button onclick="showExpiryReminders()">Send Expiry Reminders</button>
        </div>

        <div class="footer">
            <br>
            <img src="4.jpg-removebg-preview.png" alt="DVLA Logo" class="main-logo">
            Afrigyei Testing Station | Developed by Darkwah Michael 
        </div>
    </div>

    <script>
        // Mock Server Simulation
        const mockServer = {
            users: JSON.parse(localStorage.getItem('users')) || { "admin": hashPassword("1234") },
            records: JSON.parse(localStorage.getItem('records')) || []
        };

        // Password Hashing
        function hashPassword(password) {
            return CryptoJS.SHA256(password).toString();
        }

        // Input Sanitization
        function sanitizeInput(input) {
            const div = document.createElement('div');
            div.textContent = input;
            return div.innerHTML;
        }

        let currentUser = null;

        // Vehicle names for autocomplete
        const defaultVehicleNames = [
            "Toyota Corolla", "Toyota Camry", "Toyota Hilux", "Toyota Land Cruiser",
            "Honda Civic", "Honda Accord", "Honda CR-V",
            "Hyundai Tucson", "Hyundai Elantra", "Hyundai Sonata",
            "Kia Sportage", "Kia Rio", "Kia Sorento",
            "Nissan Altima", "Nissan Patrol", "Nissan Navara",
            "Ford Ranger", "Ford Explorer", "Ford Fiesta",
            "Volkswagen Golf", "Volkswagen Passat",
            "Mercedes-Benz C-Class", "Mercedes-Benz E-Class",
            "BMW 3 Series", "BMW X5"
        ];

        // Initialize vehicle names and telephone input
        document.addEventListener("DOMContentLoaded", function () {
            document.getElementById("authScreen").style.display = "flex";
            document.getElementById("welcomeScreen").style.display = "none";
            document.getElementById("worksheetContainer").style.display = "none";

            // Initialize telephone input
            const phoneInput = document.getElementById("telephoneNumber");
            const phoneError = document.getElementById("phoneError");
            phoneInput.value = "+233";
            phoneInput.addEventListener("input", (e) => enforcePhonePrefix(e, phoneError));
            phoneInput.addEventListener("keydown", preventPrefixDeletion);
            phoneInput.addEventListener("paste", handlePaste);
            phoneInput.addEventListener("focus", () => {
                if (phoneInput.value === "+233") {
                    phoneInput.setSelectionRange(4, 4);
                }
            });

            // Migrate existing records to +233 format
            mockServer.records.forEach(record => {
                if (!record.telephoneNumber.startsWith("+233")) {
                    const digits = record.telephoneNumber.replace(/[^0-9]/g, "").slice(0, 9);
                    record.telephoneNumber = "+233" + (digits.length === 9 ? digits : digits.padEnd(9, "0"));
                }
                // Migrate existing vehicle names to saved list
                if (record.vehicleName) {
                    saveVehicleName(record.vehicleName);
                }
            });
            localStorage.setItem('records', JSON.stringify(mockServer.records));

            // Initialize vehicle names datalist
            updateVehicleDatalist();
        });

        // Update vehicle names in datalist
        function updateVehicleDatalist() {
            const datalist = document.getElementById("vehicleNames");
            datalist.innerHTML = '';

            // Load saved vehicle names
            const savedVehicleNames = JSON.parse(localStorage.getItem('vehicleNames')) || [];
            const allVehicleNames = [...new Set([...defaultVehicleNames, ...savedVehicleNames])].sort((a, b) => 
                a.toLowerCase().localeCompare(b.toLowerCase())
            );

            allVehicleNames.forEach(name => {
                const option = document.createElement("option");
                option.value = name;
                datalist.appendChild(option);
            });
        }

        // Save vehicle name to localStorage
        function saveVehicleName(name) {
            if (!name || !name.trim()) return; // Prevent empty or whitespace-only names
            const cleanedName = name.trim();
            const savedVehicleNames = JSON.parse(localStorage.getItem('vehicleNames')) || [];
            
            // Check for duplicates (case-insensitive)
            if (!savedVehicleNames.some(saved => saved.toLowerCase() === cleanedName.toLowerCase())) {
                savedVehicleNames.push(cleanedName);
                localStorage.setItem('vehicleNames', JSON.stringify(savedVehicleNames));
                updateVehicleDatalist();
                
                // Visual feedback
                const vehicleInput = document.getElementById("vehicleName");
                vehicleInput.classList.add("saved");
                setTimeout(() => vehicleInput.classList.remove("saved"), 1000);
            }
        }

        // Enforce +233 prefix and validate input
        function enforcePhonePrefix(e, errorElement) {
            const input = e.target;
            let value = input.value.replace(/[^0-9+]/g, "");
            if (!value.startsWith("+233")) {
                value = "+233" + value.replace(/^\+233/, "");
            }
            input.value = value.slice(0, 13);

            if (!/^\+233\d{9}$/.test(value) && value.length > 4) {
                errorElement.style.display = "block";
                input.style.borderColor = "#e74c3c";
            } else {
                errorElement.style.display = "none";
                input.style.borderColor = "";
            }
        }

        // Prevent deletion of +233
        function preventPrefixDeletion(e) {
            const input = e.target;
            if (input.selectionStart <= 4 && (e.key === "Backspace" || e.key === "Delete")) {
                e.preventDefault();
                input.setSelectionRange(4, 4);
            }
        }

        // Handle paste events
        function handlePaste(e) {
            e.preventDefault();
            const pasted = (e.clipboardData || window.clipboardData).getData("text").replace(/[^0-9]/g, "");
            const input = e.target;
            input.value = "+233" + pasted.slice(0, 9);
            validatePhoneInput(input);
        }

        // Validate phone input
        function validatePhoneInput(input) {
            const errorElement = document.getElementById("phoneError");
            if (!/^\+233\d{9}$/.test(input.value) && input.value.length > 4) {
                errorElement.style.display = "block";
                input.style.borderColor = "#e74c3c";
            } else {
                errorElement.style.display = "none";
                input.style.borderColor = "";
            }
        }

        function showRegister() {
            document.getElementById("loginForm").style.display = "none";
            document.getElementById("registerForm").style.display = "block";
            document.getElementById("registerForm").style.animation = "flipInX 0.5s ease";
        }

        function showLogin() {
            document.getElementById("registerForm").style.display = "none";
            document.getElementById("loginForm").style.display = "block";
            document.getElementById("loginForm").style.animation = "flipInX 0.5s ease";
        }

        function forgotCredentials() {
            const choice = prompt("Type 'USERNAME' to recover your username or 'PASSWORD' to reset your PIN:");
            if (choice === 'USERNAME') {
                const usernames = Object.keys(mockServer.users);
                if (usernames.length === 0) {
                    alert("No users registered.");
                } else {
                    alert("Registered usernames:\n" + usernames.join("\n"));
                }
            } else if (choice === 'PASSWORD') {
                const username = prompt("Enter your username to reset your PIN:");
                if (!username) {
                    alert("Username is required.");
                    return;
                }
                if (!mockServer.users[username]) {
                    alert("Username not found.");
                    return;
                }
                const newPassword = prompt("Enter your new 4-digit PIN:");
                if (!newPassword || !/^\d{4}$/.test(newPassword)) {
                    alert("New PIN must be exactly 4 digits.");
                    return;
                }
                mockServer.users[username] = hashPassword(newPassword);
                localStorage.setItem('users', JSON.stringify(mockServer.users));
                alert("PIN reset successfully! Please login with your new PIN.");
            } else {
                alert("Invalid choice. Please type 'USERNAME' or 'PASSWORD'.");
            }
        }

        async function register() {
            const username = sanitizeInput(document.getElementById("regUsername").value.trim());
            const password = document.getElementById("regPassword").value;

            if (!username || !password) {
                alert("Please fill in all fields");
                return;
            }

            if (username.length < 4) {
                alert("Username must be at least 4 characters long");
                return;
            }

            if (!/^\d{4}$/.test(password)) {
                alert("PIN must be exactly 4 digits");
                return;
            }

            if (mockServer.users[username]) {
                alert("Username already exists");
                return;
            }

            mockServer.users[username] = hashPassword(password);
            localStorage.setItem('users', JSON.stringify(mockServer.users));
            alert("Registration successful! Please login with your new credentials.");
            showLogin();
            document.getElementById("regUsername").value = "";
            document.getElementById("regPassword").value = "";
        }

        async function login() {
            const username = sanitizeInput(document.getElementById("loginUsername").value.trim());
            const password = document.getElementById("loginPassword").value;

            if (!username || !password) {
                alert("Please enter both username and PIN");
                return;
            }

            if (mockServer.users[username] && mockServer.users[username] === hashPassword(password)) {
                currentUser = username;
                checkAndClearDaily();
                document.getElementById("authScreen").style.animation = "zoomOut 0.6s ease forwards";
                setTimeout(() => {
                    document.getElementById("authScreen").style.display = "none";
                    document.getElementById("welcomeScreen").style.display = "flex";
                    setTimeout(() => {
                        document.getElementById("welcomeScreen").style.animation = "zoomOut 0.6s ease forwards";
                        setTimeout(() => {
                            document.getElementById("welcomeScreen").style.display = "none";
                            document.getElementById("worksheetContainer").style.display = "block";
                            document.getElementById("userDisplay").textContent = `User: ${currentUser}`;
                            filterTable();
                        }, 600);
                    }, 2000);
                }, 600);
            } else {
                alert("Invalid username or PIN");
            }
        }

        function logout() {
            if (confirm("Are you sure you want to logout?")) {
                currentUser = null;
                document.getElementById("worksheetContainer").style.animation = "flipOutX 0.6s ease forwards";
                setTimeout(() => {
                    document.getElementById("worksheetContainer").style.display = "none";
                    document.getElementById("authScreen").style.display = "flex";
                    document.getElementById("authScreen").style.animation = "flipInX 0.6s ease";
                    document.getElementById("loginUsername").value = "";
                    document.getElementById("loginPassword").value = "";
                    showLogin();
                }, 600);
            }
        }

        async function addRow() {
            if (!currentUser) {
                alert("Please login first");
                return;
            }
            const customerName = sanitizeInput(document.getElementById("customerName").value.trim());
            const vehicleName = sanitizeInput(document.getElementById("vehicleName").value.trim());
            const vehicleNumber = sanitizeInput(document.getElementById("vehicleNumber").value.trim());
            const telephoneNumber = sanitizeInput(document.getElementById("telephoneNumber").value.trim());
            const chassisNumber = sanitizeInput(document.getElementById("chassisNumber").value.trim());
            const pc = sanitizeInput(document.getElementById("pc").value.trim());
            const expiryDate = sanitizeInput(document.getElementById("expiryDate").value);

            if (!customerName || !vehicleName || !vehicleNumber || !telephoneNumber || !chassisNumber || !pc || !expiryDate) {
                alert("Please fill out all fields");
                return;
            }

            if (!/^\+233\d{9}$/.test(telephoneNumber)) {
                alert("Please enter a valid Ghanaian telephone number (e.g., +233123456789)");
                document.getElementById("phoneError").style.display = "block";
                document.getElementById("telephoneNumber").focus();
                return;
            }

            const record = { 
                customerName,
                vehicleName, 
                vehicleNumber, 
                telephoneNumber, 
                chassisNumber, 
                pc, 
                expiryDate, 
                status: 'active',
                createdBy: currentUser,
                createdAt: new Date().toISOString()
            };
            mockServer.records.push(record);
            localStorage.setItem('records', JSON.stringify(mockServer.records));
            saveVehicleName(vehicleName); // Save vehicle name for autocomplete
            filterTable();
            clearInputs();
        }

        function clearInputs() {
            document.getElementById("customerName").value = "";
            document.getElementById("vehicleName").value = "";
            document.getElementById("vehicleNumber").value = "";
            document.getElementById("telephoneNumber").value = "+233";
            document.getElementById("chassisNumber").value = "";
            document.getElementById("pc").value = "";
            document.getElementById("expiryDate").value = "";
            document.getElementById("phoneError").style.display = "none";
            document.getElementById("telephoneNumber").style.borderColor = "";
        }

        function checkAndClearDaily() {
            const today = new Date();
            today.setHours(0, 0, 0, 0);

            let clearedCount = 0;
            mockServer.records.forEach(record => {
                if (record.status === 'active') {
                    const createdDate = new Date(record.createdAt);
                    createdDate.setHours(0, 0, 0, 0);
                    if (createdDate < today) {
                        record.status = 'cleared';
                        clearedCount++;
                    }
                }
            });

            if (clearedCount > 0) {
                localStorage.setItem('records', JSON.stringify(mockServer.records));
                console.log(`Cleared ${clearedCount} records older than today.`);
            }
        }

        function loadRecords() {
            checkAndClearDaily();
            filterTable();
        }

        function editRow(index) {
            const record = mockServer.records[index];
            document.getElementById("customerName").value = record.customerName;
            document.getElementById("vehicleName").value = record.vehicleName;
            document.getElementById("vehicleNumber").value = record.vehicleNumber;
            document.getElementById("telephoneNumber").value = record.telephoneNumber;
            document.getElementById("chassisNumber").value = record.chassisNumber;
            document.getElementById("pc").value = record.pc;
            document.getElementById("expiryDate").value = record.expiryDate;

            mockServer.records.splice(index, 1);
            localStorage.setItem('records', JSON.stringify(mockServer.records));
            filterTable();
            validatePhoneInput(document.getElementById("telephoneNumber"));
        }

        function deleteRow(index) {
            if (confirm("Are you sure you want to delete this record?")) {
                mockServer.records[index].status = 'deleted';
                localStorage.setItem('records', JSON.stringify(mockServer.records));
                filterTable();
            }
        }

        async function confirmClearTable() {
            const action = prompt("Type 'CLEAR' to clear all active records or 'DELETE' to mark as deleted:");
            if (action === 'CLEAR') {
                mockServer.records.forEach(record => {
                    if (record.status === 'active') {
                        record.status = 'cleared';
                    }
                });
                localStorage.setItem('records', JSON.stringify(mockServer.records));
                filterTable();
                alert("All active records cleared successfully.");
            } else if (action === 'DELETE') {
                if (confirm("Are you sure you want to mark all active records as deleted?")) {
                    mockServer.records.forEach(record => {
                        if (record.status === 'active') {
                            record.status = 'deleted';
                        }
                    });
                    localStorage.setItem('records', JSON.stringify(mockServer.records));
                    filterTable();
                    alert("All active records marked as deleted.");
                }
            } else {
                alert("Invalid action. Please type 'CLEAR' or 'DELETE'");
            }
        }

        async function retrieveRecords() {
            const choice = prompt("Type 'CLEARED' to retrieve cleared records or 'DELETED' to retrieve deleted records:");
            if (choice === 'CLEARED') {
                if (!mockServer.records.some(record => record.status === 'cleared')) {
                    alert("No cleared records available.");
                    return;
                }
                if (confirm("Retrieve all cleared records? This will set them to active.")) {
                    mockServer.records.forEach(record => {
                        if (record.status === 'cleared') {
                            record.status = 'active';
                            saveVehicleName(record.vehicleName); // Save vehicle name when retrieving
                        }
                    });
                    localStorage.setItem('records', JSON.stringify(mockServer.records));
                    filterTable();
                    alert("All cleared records retrieved successfully.");
                }
            } else if (choice === 'DELETED') {
                if (!mockServer.records.some(record => record.status === 'deleted')) {
                    alert("No deleted records available.");
                    return;
                }
                if (confirm("Retrieve all deleted records? This will set them to active.")) {
                    mockServer.records.forEach(record => {
                        if (record.status === 'deleted') {
                            record.status = 'active';
                            saveVehicleName(record.vehicleName); // Save vehicle name when retrieving
                        }
                    });
                    localStorage.setItem('records', JSON.stringify(mockServer.records));
                    filterTable();
                    alert("All deleted records retrieved successfully.");
                }
            } else {
                alert("Invalid choice. Please type 'CLEARED' or 'DELETED'");
            }
            // Update vehicle datalist after retrieving records
            updateVehicleDatalist();
        }

        function filterTable() {
            checkAndClearDaily();
            const searchTerm = sanitizeInput(document.getElementById("searchInput").value.toLowerCase());
            const statusFilter = document.getElementById("statusFilter").value;
            const monthFilter = document.getElementById("monthFilter").value;
            const table = document.getElementById("vehicleTable").getElementsByTagName('tbody')[0];
            table.innerHTML = '';
            
            let filteredRecords = mockServer.records;
            
            if (statusFilter === 'active') {
                filteredRecords = filteredRecords.filter(record => record.status === 'active');
            } else if (statusFilter !== 'all') {
                filteredRecords = filteredRecords.filter(record => record.status === statusFilter);
            }

            filteredRecords = filteredRecords.filter(record => {
                return record.vehicleNumber.toLowerCase().includes(searchTerm);
            });

            if (monthFilter !== 'all') {
                filteredRecords = filteredRecords.filter(record => {
                    const expiryMonth = new Date(record.expiryDate).getMonth() + 1;
                    return expiryMonth === parseInt(monthFilter);
                });
            }

            filteredRecords.forEach((record, index) => {
                let newRow = table.insertRow();
                newRow.innerHTML = `
                    <td>${index + 1}</td>
                    <td>${record.customerName}</td>
                    <td>${record.vehicleName}</td>
                    <td>${record.vehicleNumber}</td>
                    <td>${record.telephoneNumber}</td>
                    <td>${record.chassisNumber}</td>
                    <td>${record.pc}</td>
                    <td>${record.expiryDate}</td>
                    <td>${record.status}</td>
                    <td>${record.createdBy}</td>
                    <td>
                        <button class="action-btn" onclick="editRow(${mockServer.records.indexOf(record)})">Edit</button>
                        <button class="action-btn" onclick="deleteRow(${mockServer.records.indexOf(record)})">Delete</button>
                    </td>
                `;
                newRow.style.animation = "flipInRow 0.5s ease forwards";
            });
        }

        // Open export modal
        function openExportModal() {
            document.getElementById("exportModal").style.display = "flex";
        }

        // Close export modal
        function closeExportModal() {
            document.getElementById("exportModal").style.display = "none";
        }

        // Export records based on user selections
        function exportRecords() {
            const form = document.getElementById("exportForm");
            const selectedColumns = Array.from(form.querySelectorAll('input[name="columns"]:checked')).map(input => input.value);
            const exportType = form.querySelector('input[name="exportType"]:checked').value;
            const exportFiltered = document.getElementById("exportFiltered").checked;

            if (selectedColumns.length === 0) {
                alert("Please select at least one column to export.");
                return;
            }

            // Get records (filtered or all)
            let records = exportFiltered ? getFilteredRecords() : mockServer.records;

            if (records.length === 0) {
                alert("No records available to export.");
                closeExportModal();
                return;
            }

            // Map records to selected columns
            const exportData = records.map(record => {
                const row = {};
                selectedColumns.forEach(col => {
                    row[col] = record[col] || "";
                });
                return row;
            });

            try {
                if (exportType === "pdf") {
                    generatePDF(exportData, selectedColumns);
                } else {
                    generateExcel(exportData, selectedColumns);
                }
                alert("Export successful!");
                closeExportModal();
            } catch (error) {
                console.error("Export failed:", error);
                alert("Failed to export records. Please try again.");
            }
        }

        // Get currently filtered records (based on table content)
        function getFilteredRecords() {
            const table = document.getElementById("vehicleTable").getElementsByTagName("tbody")[0];
            const records = [];
            Array.from(table.rows).forEach(row => {
                const record = {
                    customerName: row.cells[1].textContent,
                    vehicleName: row.cells[2].textContent,
                    vehicleNumber: row.cells[3].textContent,
                    telephoneNumber: row.cells[4].textContent,
                    chassisNumber: row.cells[5].textContent,
                    pc: row.cells[6].textContent,
                    expiryDate: row.cells[7].textContent,
                    status: row.cells[8].textContent,
                    createdBy: row.cells[9].textContent
                };
                records.push(record);
            });
            return records;
        }

        // Generate PDF
        function generatePDF(data, columns) {
            const { jsPDF } = window.jspdf;
            const doc = new jsPDF();

            // Load logo
            const logoPath = "4.jpg-removebg-preview.png";
            try {
                doc.addImage(logoPath, "PNG", 14, 10, 30, 30);
            } catch (error) {
                console.warn("Failed to add logo to PDF:", error);
            }

            // Header
            doc.setFontSize(16);
            doc.text("Afrigyei Testing Station - Vehicle Inspection Report", 50, 20);
            doc.setFontSize(12);
            doc.text(`Inspector: ${currentUser || "Unknown"}`, 50, 28);
            doc.text(`Generated: ${new Date().toLocaleString()}`, 50, 36);

            // Map column names to human-readable headers
            const headers = columns.map(col => {
                return {
                    customerName: "Customer Name",
                    vehicleName: "Vehicle Name",
                    vehicleNumber: "Vehicle Number",
                    telephoneNumber: "Telephone Number",
                    chassisNumber: "Chassis Number",
                    pc: "P/C",
                    expiryDate: "Expiry Date",
                    status: "Status",
                    createdBy: "Created By"
                }[col] || col;
            });

            // Prepare table data
            const tableData = data.map((row, index) => [
                index + 1, // S.No
                ...columns.map(col => row[col] || "")
            ]);

            // Add table
            doc.autoTable({
                head: [["S.No", ...headers]],
                body: tableData,
                startY: 50,
                styles: { fontSize: 10 },
                headStyles: { fillColor: [44, 62, 80] },
                columnStyles: {
                    0: { cellWidth: 15 } // S.No column width
                }
            });

            doc.save(`inspection_report_${currentUser || "user"}_${new Date().toISOString().slice(0, 10)}.pdf`);
        }

        // Generate Excel
        function generateExcel(data, columns) {
            const wb = XLSX.utils.book_new();

            // Map column names to human-readable headers
            const headers = columns.map(col => {
                return {
                    customerName: "Customer Name",
                    vehicleName: "Vehicle Name",
                    vehicleNumber: "Vehicle Number",
                    telephoneNumber: "Telephone Number",
                    chassisNumber: "Chassis Number",
                    pc: "P/C",
                    expiryDate: "Expiry Date",
                    status: "Status",
                    createdBy: "Created By"
                }[col] || col;
            });

            // Prepare data for Excel
            const excelData = data.map((row, index) => {
                const rowData = { "S.No": index + 1 };
                columns.forEach((col, i) => {
                    rowData[headers[i]] = row[col] || "";
                });
                return rowData;
            });

            const ws = XLSX.utils.json_to_sheet(excelData);
            XLSX.utils.book_append_sheet(wb, ws, "Vehicle Records");
            XLSX.writeFile(wb, `inspection_report_${currentUser || "user"}_${new Date().toISOString().slice(0, 10)}.xlsx`);
        }

        function showExpiryReminders() {
            const reminderTable = document.getElementById("reminderTable").getElementsByTagName('tbody')[0];
            reminderTable.innerHTML = '';
            const today = new Date();
            const reminderThreshold = new Date(today);
            reminderThreshold.setDate(today.getDate() + 7);

            const upcomingRecords = mockServer.records.filter(record => {
                if (record.status !== 'active') return false;
                const expiryDate = new Date(record.expiryDate);
                return expiryDate >= today && expiryDate <= reminderThreshold;
            });

            if (upcomingRecords.length === 0) {
                alert("No vehicles with expiry dates within the next 7 days.");
                return;
            }

            upcomingRecords.forEach(record => {
                const row = reminderTable.insertRow();
                row.innerHTML = `
                    <td>${record.customerName}</td>
                    <td>${record.vehicleNumber}</td>
                    <td>${record.telephoneNumber}</td>
                    <td>${record.expiryDate}</td>
                    <td>
                        <button class="send-btn" onclick="sendReminder('${record.telephoneNumber}', '${record.customerName}', '${record.vehicleNumber}', '${record.expiryDate}')">Send Reminder</button>
                    </td>
                `;
            });

            document.getElementById("reminderModal").style.display = "flex";
        }

        function sendReminder(phoneNumber, customerName, vehicleNumber, expiryDate) {
            const message = `Dear ${customerName}, your vehicle ${vehicleNumber} Roadworthy is due to expire on ${expiryDate}. Please visit Afrigyei Testing Station (AWOSHIE DVLA) to renew.`;
            const encodedMessage = encodeURIComponent(message);
            const whatsappUrl = `https://wa.me/${phoneNumber}?text=${encodedMessage}`;
            window.open(whatsappUrl, '_blank');
        }

        function closeReminderModal() {
            document.getElementById("reminderModal").style.display = "none";
        }

        const styleSheet = document.createElement('style');
        styleSheet.textContent = `
            @keyframes flipInRow {
                from { opacity: 0; transform: perspective(500px) rotateX(-90deg); }
                to { opacity: 1; transform: perspective(500px) rotateX(0deg); }
            }
            @keyframes flipOutRow {
                from { opacity: 1; transform: perspective(500px) rotateX(0deg); }
                to { opacity: 0; transform: perspective(500px) rotateX(90deg); }
            }
            @keyframes zoomOut {
                from { opacity: 1; transform: scale(1); }
                to { opacity: 0; transform: scale(0.8); }
            }
            @keyframes flipInX {
                from { opacity: 0; transform: perspective(500px) rotateX(90deg); }
                to { opacity: 1; transform: perspective(500px) rotateX(0deg); }
            }
            @keyframes flipOutX {
                from { opacity: 1; transform: perspective(500px) rotateX(0deg); }
                to { opacity: 0; transform: perspective(500px) rotateX(-90deg); }
            }
        `;
        document.head.appendChild(styleSheet);
    </script>
</body>
</html>
